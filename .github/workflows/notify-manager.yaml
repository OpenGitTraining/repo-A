name: Notify Orchestrator on RC created

on:
  # Fires when you create a prerelease in the UI or via API
  release:
    types: [prereleased]

  # Allows other workflows in this repo to call it directly
  workflow_call:
    inputs:
      tag:
        required: true
        type: string
      release_url:
        required: false
        type: string
      source_repo:
        required: false
        type: string

permissions:
  contents: read

env:
  ORCH_REPO: OpenGitTraining/repo-a-manager
  ORCH_EVENT_TYPE: rc-created

jobs:
  notify-orchestrator:
    runs-on: ubuntu-latest

    steps:
      # Normalize inputs: support both 'release' and 'workflow_call'
      - name: Collect tag / repo / url
        id: info
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            SRC_REPO="${{ github.repository }}"
            RELEASE_URL="${{ github.event.release.html_url }}"
          else
            TAG="${{ inputs.tag }}"
            SRC_REPO="${{ inputs.source_repo || github.repository }}"
            RELEASE_URL="${{ inputs.release_url || '' }}"
          fi

          if [ -z "$TAG" ]; then
            echo "Tag is empty, cannot notify orchestrator."
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "repo=$SRC_REPO" >> "$GITHUB_OUTPUT"
          echo "url=$RELEASE_URL" >> "$GITHUB_OUTPUT"

          echo "Normalized values:"
          echo "  TAG:        $TAG"
          echo "  SRC_REPO:   $SRC_REPO"
          echo "  RELEASE_URL:$RELEASE_URL"

      - name: Check that this is an RC tag
        id: rc_check
        run: |
          TAG="${{ steps.info.outputs.tag }}"
          if [[ "$TAG" != *"-rc"* ]]; then
            echo "This release tag ($TAG) does not look like an RC (no '-rc' suffix)."
            echo "should_notify=false" >> "$GITHUB_OUTPUT"
          else
            echo "Detected RC tag: $TAG"
            echo "should_notify=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip non-RC releases
        if: steps.rc_check.outputs.should_notify != 'true'
        run: echo "Not an RC â†’ skipping notification to orchestrator."

      - name: Generate installation token (GitHub App)
        if: steps.rc_check.outputs.should_notify == 'true'
        id: app_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.GH_APP__CI_ORCHESTRATOR__ID }}
          private-key: ${{ secrets.GH_APP__CI_ORCHESTRATOR__PRIVATE_KEY }}

      - name: Notify orchestrator (repo-a-manager)
        if: steps.rc_check.outputs.should_notify == 'true'
        run: |
          TAG="${{ steps.info.outputs.tag }}"
          SRC_REPO="${{ steps.info.outputs.repo }}"
          RELEASE_URL="${{ steps.info.outputs.url }}"

          echo "Notifying orchestrator ${{ env.ORCH_REPO }} for $SRC_REPO@$TAG"

          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ steps.app_token.outputs.token }}" \
            "https://api.github.com/repos/${{ env.ORCH_REPO }}/dispatches" \
            -d @- <<EOF
          {
            "event_type": "${{ env.ORCH_EVENT_TYPE }}",
            "client_payload": {
              "source_repo": "$SRC_REPO",
              "tag": "$TAG",
              "release_url": "$RELEASE_URL"
            }
          }
          EOF
