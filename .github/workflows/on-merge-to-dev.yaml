name: On Merge To Dev
run-name: On Merge To Dev

on:
    workflow_dispatch:
    push:
        branches: ["dev"]

permissions:
  contents: write

jobs:
  build:
    uses: ./.github/workflows/build.yaml
    with:
      cmake_build_type: Release
      upload_artifacts: true

  release_rc:
    needs: build
    runs-on: [ ubuntu-latest ]

    outputs:
        tag: ${{ steps.prerelease.outputs.tag }}
        release_url: ${{ steps.prerelease.outputs.release_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download staged outputs
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: ${{ needs.build.outputs.out_dir }}

      - name: Tagging
        id: tagging
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git fetch --tags origin

          echo "Fetching latest tag with gh..."
          LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')

          if [ -z "$LATEST_TAG" ]; then
            BASE_VERSION="0.1.0"
            RC_TAG="${BASE_VERSION}-rc"
          else
            echo "Latest tag found: $LATEST_TAG"

            LATEST_TAG="${LATEST_TAG#refs/tags/}"
            LATEST_TAG_NO_V="${LATEST_TAG#v}"
            BASE_PART="${LATEST_TAG_NO_V%%-rc*}"

            IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_PART"
            if [ -z "$MAJOR" ] || [ -z "$MINOR" ] || [ -z "$PATCH" ]; then
              echo "ERROR: Could not parse a valid semver from tag '$LATEST_TAG'"
              exit 1
            fi

            PATCH=$((PATCH + 1))
            BASE_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            RC_TAG="${BASE_VERSION}-rc"
          fi

          echo "base_version=$BASE_VERSION" >> "$GITHUB_OUTPUT"
          echo "rc_tag=$RC_TAG" >> "$GITHUB_OUTPUT"

      - name: Create RC tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git tag "${{ steps.tagging.outputs.rc_tag }}" "${GITHUB_SHA}"
          git push origin "${{ steps.tagging.outputs.rc_tag }}"

      - name: Create GitHub Pre-Release
        id: prerelease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.tagging.outputs.rc_tag }}"

          echo "$ASSETS"
          ls -la "${{ needs.build.outputs.out_dir }}" || true

          gh release create "$TAG" \
          "${{ needs.build.outputs.out_dir }}"/* \
          --prerelease \
          --title "Pre-Release $TAG" \
          --notes "Automated Pre-release"

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "release_url=https://github.com/$GITHUB_REPOSITORY/releases/tag/$TAG" >> "$GITHUB_OUTPUT"

  notify:
    needs: build
    uses: OpenGitTraining/repo-A/.github/workflows/notify-manager.yaml@main
    with:
      tag: ${{ needs.build.outputs.tag }}
      release_url: ${{ needs.build.outputs.release_url }}
      source_repo: ${{ github.repository }}
    secrets: inherit
