name: Main

on:
    workflow_dispatch:
    pull_request:
        branches: ["main"]
    # push:
    #     branches: [ "main" ]

permissions:
  contents: write

jobs:
    build:
        runs-on: [ ubuntu-latest ]

        outputs:
            tag: ${{ steps.prerelease.outputs.tag }}
            release_url: ${{ steps.prerelease.outputs.release_url }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Generate
              run: |
                cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

            - name: Build
              run: |
                cmake --build build --config Release

            - name: Test
              run: |
                ctest --test-dir build -C Release --output-on-failure

            - name: Package
              run: |
                cmake --build build --target package

            - name: Tagging
              id: tagging
              run: |
                # fetch tags so git can see them
                git fetch --tags origin

                echo "Fetching latest tag with gh..."
                LATEST_TAG=$(git tag --list --sort=-creatordate | head -n 1 || echo "")

                if [ -z "$LATEST_TAG" ]; then
                  # No tags yet â†’ first version
                  BASE_VERSION="0.1.0"
                  RC_TAG="${BASE_VERSION}-rc"
                else
                  echo "Latest tag found: $LATEST_TAG"

                  # Strip optional leading refs/tags/ and v
                  LATEST_TAG="${LATEST_TAG#refs/tags/}"
                  LATEST_TAG_NO_V="${LATEST_TAG#v}"

                  # Remove -rc or -rc.N suffix if present
                  BASE_PART="${LATEST_TAG_NO_V%%-rc*}"

                  echo "Base part parsed: $BASE_PART"

                  # Split version
                  IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_PART"

                  if [ -z "$MAJOR" ] || [ -z "$MINOR" ] || [ -z "$PATCH" ]; then
                    echo "ERROR: Could not parse a valid semver from tag '$LATEST_TAG'"
                    exit 1
                  fi

                  # Bump patch for new RC
                  PATCH=$((PATCH + 1))
                  BASE_VERSION="${MAJOR}.${MINOR}.${PATCH}"
                  RC_TAG="${BASE_VERSION}-rc"
                fi

                echo "base_version=$BASE_VERSION"
                echo "rc_tag=$RC_TAG"

                echo "base_version=$BASE_VERSION" >> "$GITHUB_OUTPUT"
                echo "rc_tag=$RC_TAG" >> "$GITHUB_OUTPUT"

            - name: Create RC tag
              id: create_rc
              run: |
                git config user.name "github-actions"
                git config user.email "github-actions@users.noreply.github.com"

                git tag "${{ steps.tagging.outputs.rc_tag }}" "${GITHUB_SHA}"
                git push origin "${{ steps.tagging.outputs.rc_tag }}"

            - name: Create GitHub Pre-Release
              id: prerelease
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                TAG="${{ steps.tagging.outputs.rc_tag }}"
                ASSETS=$(find ./out -type f )
                echo "$ASSETS"

                gh release create "$TAG" \
                ./out/* \
                --prerelease \
                --title "Pre-Release $TAG" \
                --notes "Automated Pre-release"

                echo "tag=$TAG" >> "$GITHUB_OUTPUT"
                # Release URL (for convenience, optional)
                URL="https://github.com/$GITHUB_REPOSITORY/releases/tag/$TAG"
                echo "release_url=$URL" >> "$GITHUB_OUTPUT"

    notify:
      needs: build
      uses: OpenGitTraining/repo-A/.github/workflows/notify-manager.yaml@main
      with:
        tag: ${{ needs.build.outputs.tag }}
        release_url: ${{ needs.build.outputs.release_url }}
        source_repo: ${{ github.repository }}
