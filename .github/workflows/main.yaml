name: A Build Workflow
run-name: Build, Test and Deploy Repo-A

on:
    workflow_dispatch:
    pull_request:
        branches: ["main"]
    push:
        branches: [ "main" ]

permissions:
  contents: write

jobs:
    build:
        runs-on: [ ubuntu-latest ]
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Generate
              run: |
                cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

            - name: Build
              run: |
                cmake --build build --config Release

            - name: Test
              run: |
                ctest --test-dir build -C Release --output-on-failure

            - name: Package
              run: |
                cmake --build build --target package

            - name: Tagging
              id: tagging
              run: |
                # fetch tags so git can see them
                git fetch --tags origin

                # list all tags (change the pattern later if you want)
                TAGS=$(git tag --list)

                if [ -z "$TAGS" ]; then
                  # No tags yet â†’ first version
                  BASE_VERSION="0.1.0"
                  RC_TAG="${BASE_VERSION}-rc"
                else
                  # TODO: logic for bumping from the latest tag
                  # For now just fail so you notice
                  echo "Existing tags found, but bump logic is not implemented yet."
                  exit 1
                fi

                echo "base_version=$BASE_VERSION"
                echo "rc_tag=$RC_TAG"

                echo "base_version=$BASE_VERSION" >> "$GITHUB_OUTPUT"
                echo "rc_tag=$RC_TAG" >> "$GITHUB_OUTPUT"
            
            - name: Create RC tag
              run: |
                git config user.name "github-actions"
                git config user.email "github-actions@users.noreply.github.com"

                git tag "${{ steps.tagging.outputs.rc_tag }}" "${GITHUB_SHA}"
                git push origin "${{ steps.tagging.outputs.rc_tag }}"

            - name: Create GitHub Release
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                TAG="${{ steps.tagging.outputs.rc_tag }}"
                gh release create "$TAG" \
                ./out/* \
                --prerelease \
                --title "Release $TAG" \
                --notes "Automated release"
