name: Promote RC to final release
run-name: Promote RC to final release

on:
  repository_dispatch:
    types: [promote-rc]

permissions:
  contents: write   # required to create tags & releases

jobs:
  promote:
    runs-on: ubuntu-latest

    steps:
      - name: Extract RC tag from payload
        id: info
        run: |
          RC_TAG="${{ github.event.client_payload.tag }}"
          if [ -z "$RC_TAG" ]; then
            echo "RC tag not provided in client_payload.tag"
            exit 1
          fi

          # Strip from first "-rc" onwards: "v1.2.3-rc1" -> "v1.2.3"
          FINAL_TAG="${RC_TAG%%-rc*}"

          echo "rc_tag=$RC_TAG" >> "$GITHUB_OUTPUT"
          echo "final_tag=$FINAL_TAG" >> "$GITHUB_OUTPUT"

          echo "RC tag: $RC_TAG"
          echo "Final tag: $FINAL_TAG"

      - name: Download RC assets and resolve commit SHA
        id: resolved
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RC_TAG="${{ steps.info.outputs.rc_tag }}"
          REPO="${GITHUB_REPOSITORY}"

          rm -rf out
          mkdir -p out

          echo "Downloading assets from RC release $RC_TAG in $REPO ..."
          gh release download "$RC_TAG" --dir out --repo "$REPO"

          echo "Assets downloaded to out/:"
          ls -la out || true

          # Fail fast if there are no assets (this is the most common root cause)
          if [ -z "$(ls -A out 2>/dev/null)" ]; then
            echo "ERROR: No assets were downloaded from RC release $RC_TAG."
            echo "This means the RC prerelease likely has no uploaded assets."
            echo "Check the RC prerelease step in On Merge To Dev: it must upload the CPack outputs to the prerelease."
            exit 1
          fi

          echo "Resolving commit SHA for tag $RC_TAG ..."

          # Get ref object SHA (could be commit SHA for lightweight tag or tag-object SHA for annotated tag)
          REF_OBJ_SHA=$(gh api "repos/$REPO/git/ref/tags/$RC_TAG" --jq '.object.sha')

          if [ -z "$REF_OBJ_SHA" ]; then
            echo "ERROR: Could not resolve tag ref for $RC_TAG"
            exit 1
          fi

          # If annotated tag, dereference to commit; else keep as-is
          # echo "REF_OBJ_SHA: $REF_OBJ_SHA"
          # COMMIT_SHA=$(gh api "repos/$REPO/git/tags/$REF_OBJ_SHA" --jq '.object.sha' 2>/dev/null || echo "REF_OBJ_SHA: $REF_OBJ_SHA")

          # if [ -z "$COMMIT_SHA" ]; then
          #   echo "ERROR: Could not resolve commit SHA for $RC_TAG"
          #   exit 1
          # fi

          echo "commit_sha=$REF_OBJ_SHA" >> "$GITHUB_OUTPUT"
          echo "Commit SHA: $REF_OBJ_SHA"

      - name: Create final tag (x.y.z)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FINAL_TAG="${{ steps.info.outputs.final_tag }}"
          SHA="${{ steps.resolved.outputs.commit_sha }}"

          echo "Creating final tag $FINAL_TAG at $SHA"

          # Try to create the ref; ignore error if it already exists
          gh api "repos/$GITHUB_REPOSITORY/git/refs" \
            -X POST \
            -f ref="refs/tags/$FINAL_TAG" \
            -f sha="$SHA" || echo "Tag $FINAL_TAG may already exist, continuing."

      - name: Create or update final release (x.y.z) with RC assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FINAL_TAG="${{ steps.info.outputs.final_tag }}"
          RC_TAG="${{ steps.info.outputs.rc_tag }}"
          SHA="${{ steps.resolved.outputs.commit_sha }}"
          REPO="${GITHUB_REPOSITORY}"

          echo "Ensuring final release $FINAL_TAG exists (from RC $RC_TAG)"
          echo "Assets present in out/:"
          find out -maxdepth 1 -type f -print -ls

          if gh release view "$FINAL_TAG" --repo "$REPO" >/dev/null 2>&1; then
            echo "Release exists; uploading assets..."
            gh release upload "$FINAL_TAG" out/* --clobber --repo "$REPO"
            gh release edit "$FINAL_TAG" \
              --title "$FINAL_TAG" \
              --notes "Promotion of RC $RC_TAG" \
              --repo "$REPO"
          else
            echo "Creating new release..."
            gh release create "$FINAL_TAG" \
              out/* \
              --target "$SHA" \
              --title "$FINAL_TAG" \
              --notes "Promotion of RC $RC_TAG" \
              --repo "$REPO"
          fi

          echo "Final release $FINAL_TAG ready."